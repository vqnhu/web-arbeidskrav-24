var push={init:function(){if(location.hostname!='www.dreamstime.com'&&!location.href.match(/wpn=1/)){return}
if(location.pathname&&location.pathname.match(/^\/upload/)){return}
push.load(['https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js','https://www.gstatic.com/firebasejs/8.2.1/firebase-messaging.js']).then(function(){push.start();push.pushInit()})},load:function(url){if(typeof url=="object"&&'forEach' in url){var sequence=Promise.resolve();url.forEach(function(url){sequence=sequence.then(function(){return push.load(url)})});return sequence}
return new Promise(function(resolve,reject){var element=document.createElement('script');var parent='body';var attr='src';element.onload=function(){resolve(url)};element.onerror=function(){reject(url)};element.async=!0;element[attr]=url;document[parent].appendChild(element)})},start:function(){var config={apiKey:"AIzaSyC2VKFNKJ7gk4XopbCmdnl6UyCgqh6qL2I",authDomain:"acoustic-patrol-174809.firebaseapp.com",databaseURL:"https://acoustic-patrol-174809.firebaseio.com",projectId:"acoustic-patrol-174809",storageBucket:"acoustic-patrol-174809.appspot.com",messagingSenderId:"716229567248",appId:"1:716229567248:android:fcdd6c0a8adc7bbc"};firebase.initializeApp(config);push.messaging=firebase.messaging();push.messaging.usePublicVapidKey('BKRn1X6SkyHFCuNA3bsQBBAQNll5SxOLVlUOOAfQCkadxlrs6ho7fe3CHpdzZJPVOgd2nrooLfsslbZpT7cxfHg');push.messaging.onTokenRefresh(function(){push.messaging.getToken().then(function(refreshedToken){push.sendTokenToServer(refreshedToken)}).catch(function(err){})});push.messaging.onMessage(function(payload){try{var token=payload.data.token;var title=payload.data.title;var options={body:payload.data.body,icon:payload.data.icon,image:payload.data.image,data:{click_action:payload.data.click_action},tag:title+payload.data.click_action,requireInteraction:!0};var hTokens={};var tokens=[];if(token){hTokens[token]=1;tokens.push(token)}
push.messaging.getToken().then(function(currentToken){if(currentToken&&!hTokens[currentToken]){hTokens[currentToken]=1;tokens.push(currentToken)}
var openRequest=self.indexedDB.open('wpn',1);openRequest.onupgradeneeded=function(event){var db=event.target.result;var store=db.createObjectStore('tokens',{keyPath:'token'});store.createIndex('token','token',{unique:!0})};openRequest.onsuccess=function(event){var db=openRequest.result;var transaction=db.transaction('tokens','readwrite');var objectStore=transaction.objectStore('tokens');for(var t in hTokens){objectStore.put({token:t})}}}).then(function(){try{var n=new Notification(title,options);n.onclick=function(event){event.preventDefault();window.open(payload.data.click_action,'_blank');n.close()}}catch(err){try{navigator.serviceWorker.ready.then(function(registration){return registration.showNotification(title,options)}).catch(function(err){})}catch(err){}}}).then(function(){return push.checkTokens()}).catch(function(err){})}catch(err){}})},pushInit:function(){push.messaging.getToken().then(function(currentToken){if(currentToken){push.sendTokenToServer(currentToken)}else{push.setTokenSentToServer('')}}).then(function(){return push.checkTokens()}).catch(function(err){push.setTokenSentToServer('')})},checkTokens:function(){push.messaging.getToken().then(function(currentToken){var hTokens={};var tokens=[];var openRequest=self.indexedDB.open('wpn',1);openRequest.onupgradeneeded=function(event){var db=event.target.result;var store=db.createObjectStore('tokens',{keyPath:'token'});store.createIndex('token','token',{unique:!0})};openRequest.onsuccess=function(event){var db=openRequest.result;var transaction=db.transaction('tokens','readwrite');var objectStore=transaction.objectStore('tokens');objectStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){if(cursor.value&&cursor.value.token&&!hTokens[cursor.value.token]){hTokens[cursor.value.token]=1;tokens.push(cursor.value.token)}
cursor.continue()}else{if(tokens.length>1){for(var t in hTokens){push.uninstallToken(t);push.messaging.deleteToken(t).catch(function(err){});objectStore.delete(t)}
setTimeout(push.pushInit,1000)}}}}}).catch(function(err){})},sendTokenToServer:function(currentToken){if(!push.isTokenSentToServer(currentToken)){push.saveToken(currentToken)}else{}},isTokenSentToServer:function(token){return window.localStorage.getItem('tokenSentToServer')===token},setTokenSentToServer:function(token){window.localStorage.setItem('tokenSentToServer',token)},requestPermission:function(){if(typeof show_wpn=="undefined"||!show_wpn){return}
Notification.requestPermission().then(function(permission){if(permission==='granted'){push.pushInit()}else{}})},deleteToken:function(){push.messaging.getToken().then(function(currentToken){push.uninstallToken(currentToken);push.messaging.deleteToken(currentToken).then(function(){push.setTokenSentToServer('');push.pushInit()}).catch(function(err){})}).catch(function(err){})},uninstallToken:function(token){var formData=new FormData();formData.append('token',token);formData.append('d',1);formData.append('securitycheck',securitycheck);fetch("/ajax/push.php",{method:"POST",body:formData})},saveToken:function(token){var formData=new FormData();formData.append('token',token);formData.append('securitycheck',securitycheck);fetch("/ajax/push.php",{method:"POST",body:formData}).then(function(result){if(result&&result.ok){result.text().then(function(result){push.onSaveToken(token,result==='true')})}})},onSaveToken:function(token,result){if(result){push.setTokenSentToServer(token)}else{push.deleteToken()}}};push.init()